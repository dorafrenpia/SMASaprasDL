<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Berita Acara Kerusakan</title>
  <link rel="stylesheet" href="pdf.css">
  <style>
    img.previewFoto {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
    }
    table img {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h2>üìù Form Berita Acara Kerusakan</h2>

  <form id="formData">
    <label>Hari:</label>
    <input type="text" id="hari" required>

    <label>Tanggal Kejadian:</label>
    <input type="date" id="tanggalLengkap" required>

    <label>Nama Barang:</label>
    <input type="text" id="namaBarang">

    <label>Spesifikasi:</label>
    <input type="text" id="spesifikasi">

    <label>Jumlah:</label>
    <input type="number" id="jumlah">

    <label>Lokasi:</label>
    <input type="text" id="lokasiBarang">

    <label>Kondisi:</label>
    <input type="text" id="kondisi">

    <!-- üîπ Tambahan: upload foto -->
    <label>Foto Barang Rusak:</label>
    <input type="file" id="fotoBarang" accept="image/*">
    <img id="previewFoto" class="previewFoto" style="display:none;">

    <label>Tindakan yang Akurat:</label>
    <input type="text" id="tindakan">

    <button type="button" class="add-btn" id="btnTambahBarang">+ Tambahkan Barang Rusak</button>

    <label>Nama Pelapor:</label>
    <input type="text" id="melapor" required readonly>

    <label>Nama Mengetahui:</label>
    <input type="text" id="mengetahui" required>
  </form>

  <div class="a4" id="preview" style="display:none;">
    <div class="content" id="isiSurat"></div>

    <div class="signature">
      <div>
        <p>Yang Mengetahui,</p>
        <p><b>Koordinator Sarana Prasarana</b></p>
        <br><br><br>
        <p><u id="tandaMengetahui">____________________</u></p>
      </div>
      <div>
        <p>Yang Melaporkan,</p>
        <br><br><br>
        <p><u id="tandaMelapor">____________________</u></p>
      </div>
    </div>
  </div>

<script>
  const inputs = document.querySelectorAll('#formData input');
  const btnTambahBarang = document.getElementById('btnTambahBarang');
  const daftarBarang = [];
  let fotoBase64 = ""; // tempat sementara untuk simpan foto barang

  // üîπ Preview foto saat upload
  document.getElementById('fotoBarang').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      fotoBase64 = evt.target.result;
      const imgPreview = document.getElementById('previewFoto');
      imgPreview.src = fotoBase64;
      imgPreview.style.display = "block";
    };
    reader.readAsDataURL(file);
  });

  // üîπ Ambil user login dari localStorage
  const userLogin = JSON.parse(localStorage.getItem("userLogin"));
  if (userLogin && userLogin.nama) {
    document.getElementById("melapor").value = userLogin.nama;
  } else {
    alert("‚ö†Ô∏è Silakan login terlebih dahulu!");
    // window.location.href = "../../LOGIN/html/login.html";
  }

  showPreview();
  inputs.forEach(input => input.addEventListener('input', showPreview));

  // üîπ Tambah barang rusak ke daftar
  btnTambahBarang.addEventListener('click', () => {
    const namaBarang = document.getElementById('namaBarang').value.trim();
    const spesifikasi = document.getElementById('spesifikasi').value.trim();
    const jumlah = document.getElementById('jumlah').value.trim();
    const lokasiBarang = document.getElementById('lokasiBarang').value.trim();
    const kondisi = document.getElementById('kondisi').value.trim();
    const tindakan = document.getElementById('tindakan').value.trim();

    if (!namaBarang) {
      alert("Masukkan minimal nama barang!");
      return;
    }

    if (!fotoBase64) {
      alert("Harap upload foto barang rusak!");
      return;
    }

    daftarBarang.push({
      namaBarang, spesifikasi, jumlah, lokasiBarang, kondisi, tindakan, foto: fotoBase64
    });

    // üîπ Reset input
    document.getElementById('namaBarang').value = "";
    document.getElementById('spesifikasi').value = "";
    document.getElementById('jumlah').value = "";
    document.getElementById('lokasiBarang').value = "";
    document.getElementById('kondisi').value = "";
    document.getElementById('tindakan').value = "";
    document.getElementById('fotoBarang').value = "";
    document.getElementById('previewFoto').style.display = "none";
    fotoBase64 = "";

    showPreview();
  });

  // üîπ Tampilkan preview surat
  function showPreview() {
    const hari = document.getElementById('hari').value.trim() || "________";
    const tanggalInput = document.getElementById('tanggalLengkap').value;
    const melapor = document.getElementById('melapor').value.trim() || "________________";
    const mengetahui = document.getElementById('mengetahui').value.trim() || "________________";

    let tanggalText = "________";
    if (tanggalInput) {
      const date = new Date(tanggalInput);
      const options = { day: 'numeric', month: 'long', year: 'numeric' };
      tanggalText = date.toLocaleDateString('id-ID', options);
    }

    let tableHTML = "";
    if (daftarBarang.length > 0) {
      tableHTML += `
        <table>
          <tr>
            <th>No.</th>
            <th>Nama Barang/Peralatan</th>
            <th>Spesifikasi</th>
            <th>Jumlah</th>
            <th>Lokasi</th>
            <th>Kondisi</th>
            <th>Tindakan yang Akurat</th>
            <th>Foto</th>
          </tr>
      `;
      daftarBarang.forEach((b, i) => {
        tableHTML += `
          <tr>
            <td>${i + 1}</td>
            <td>${b.namaBarang}</td>
            <td>${b.spesifikasi}</td>
            <td>${b.jumlah}</td>
            <td>${b.lokasiBarang}</td>
            <td>${b.kondisi}</td>
            <td>${b.tindakan}</td>
            <td><img src="${b.foto}" alt="Foto Barang Rusak"></td>
          </tr>
        `;
      });
      tableHTML += `</table>`;
    } else {
      tableHTML = `<p><i>Belum ada barang rusak yang ditambahkan.</i></p>`;
    }

    document.getElementById('isiSurat').innerHTML = `
      <p>Pada hari <b>${hari}</b> tanggal <b>${tanggalText}</b>, telah terjadi kerusakan pada beberapa perangkat berikut:</p>
      ${tableHTML}
      <p>Barang-barang tersebut dilaporkan rusak oleh <b>${melapor}</b> dan telah dilakukan pengecekan awal untuk memastikan kondisi alat.</p>
      <p>Demikian berita acara ini dibuat dengan sebenar-benarnya untuk dapat digunakan sebagaimana mestinya.</p>
    `;

    document.getElementById('tandaMengetahui').textContent = mengetahui;
    document.getElementById('tandaMelapor').textContent = melapor;
    document.getElementById('preview').style.display = "block";
  }
</script>

</body>
</html>
