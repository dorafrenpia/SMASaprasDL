<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Upload ke Google Drive</title>
</head>
<body>
  <h2>Login & Upload ke Google Drive</h2>

  <div id="driveSection">
    <button id="loginDriveBtn">Login Google Drive</button>
    <button id="logoutDriveBtn" disabled>Logout Drive</button><br><br>

    <input type="file" id="fileInput"><br><br>
    <button id="uploadBtn" disabled>Upload File ke Drive</button>
    <p id="uploadStatus">Belum ada file diupload.</p>
  </div>
<script type="module">
  const CLIENT_ID = "1008287671477-rm03r2f3e52h8c95047uk3kjqlo52atn.apps.googleusercontent.com";
  const SCOPES = "https://www.googleapis.com/auth/drive.file";
  const FOLDER_ID = "1YacRANfXMvLnV5hXCHxCiywKJv7h13Gh";

  let accessToken = "";
  let tokenClient;

  const loginDriveBtn = document.getElementById("loginDriveBtn");
  const logoutDriveBtn = document.getElementById("logoutDriveBtn");
  const uploadBtn = document.getElementById("uploadBtn");
  const fileInput = document.getElementById("fileInput");
  const uploadStatus = document.getElementById("uploadStatus");

  // üß† Fungsi update UI
  function updateUI(isLoggedIn) {
    loginDriveBtn.disabled = isLoggedIn;
    logoutDriveBtn.disabled = !isLoggedIn;
    uploadBtn.disabled = !isLoggedIn;
  }

  // üöÄ Saat halaman dimuat
  window.onload = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: SCOPES,
      callback: (tokenResponse) => {
        accessToken = tokenResponse.access_token;
        localStorage.setItem("accessToken", accessToken);
        localStorage.setItem("isDriveLoggedIn", "true");
        updateUI(true);
        uploadStatus.textContent = "üü¢ Sudah login ke Google Drive. Siap upload.";
      },
    });

    // üîπ Ambil data login dari localStorage
    const savedLogin = localStorage.getItem("isDriveLoggedIn");
    const savedToken = localStorage.getItem("accessToken");

    if (savedLogin === "true" && savedToken) {
      accessToken = savedToken;
      updateUI(true);
      uploadStatus.textContent = "üü¢ Sudah login ke Google Drive. Siap upload.";
    } else {
      updateUI(false);
      uploadStatus.textContent = "Belum ada file diupload.";
    }
  };

  // üü¢ Login ke Google Drive
  loginDriveBtn.addEventListener("click", () => {
    tokenClient.requestAccessToken({ prompt: "consent" });
  });

  // üî¥ Logout
  logoutDriveBtn.addEventListener("click", () => {
    accessToken = "";
    localStorage.removeItem("isDriveLoggedIn");
    localStorage.removeItem("accessToken");
    updateUI(false);
    uploadStatus.textContent = "Belum ada file diupload.";
    alert("‚úÖ Logout dari Google Drive berhasil!");
  });

  // üìÇ Upload File ke Drive
  uploadBtn.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return alert("Pilih file dulu!");
    if (!accessToken) return alert("Login dulu ke Google Drive!");

    const metadata = {
      name: file.name,
      parents: [FOLDER_ID]
    };

    const form = new FormData();
    form.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
    form.append("file", file);

    try {
      const response = await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id", {
        method: "POST",
        headers: { Authorization: "Bearer " + accessToken },
        body: form
      });

      const result = await response.json();

      if (result.id) {
        const link = `https://drive.google.com/file/d/${result.id}/view?usp=sharing`;
        uploadStatus.innerHTML = `‚úÖ Berhasil upload!<br>Link: <a href="${link}" target="_blank">${link}</a>`;

        // üíæ Simpan ke localStorage
        let uploads = JSON.parse(localStorage.getItem("uploadedFiles") || "[]");
        uploads.push({ name: file.name, link });
        localStorage.setItem("uploadedFiles", JSON.stringify(uploads));
      } else {
        // Jika gagal upload karena token invalid, minta token baru
        if (result.error && result.error.code === 401) {
          alert("üîÑ Token kadaluarsa. Silakan login ulang ke Google Drive.");
          localStorage.removeItem("accessToken");
          localStorage.setItem("isDriveLoggedIn", "false");
          updateUI(false);
        } else {
          uploadStatus.textContent = "‚ùå Gagal upload: " + JSON.stringify(result);
        }
      }
    } catch (err) {
      uploadStatus.textContent = "‚ùå Terjadi error: " + err;
    }
  });
</script>

<!-- Google API -->
<script async defer src="https://accounts.google.com/gsi/client"></script>

<!-- Google API -->
<script async defer src="https://accounts.google.com/gsi/client"></script>


  <!-- Script Google API -->
  <script async defer src="https://accounts.google.com/gsi/client"></script>
</body>
</html>
